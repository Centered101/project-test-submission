<!DOCTYPE html>
<html lang="th">

<head>
    <title>อัปโหลดใบประกาศนียบัตร</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="theme-color" content="#409EFE">
    <meta name="keywords" content="HTML, CSS, XML, JavaScript, TailwindCSS, jQuery, Certificates, Centered101">
    <meta name="author" content="Centered101">
    <meta name="description" content="อัปโหลดใบประกาศนียบัตร">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://project-test-submission.netlify.app">
    <meta property="og:title" content="อัปโหลดใบประกาศนียบัตร">
    <meta property="og:description" content="ใบประกาศนียบัตร">
    <meta property="og:image" content="/images/icon.svg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://project-test-submission.netlify.app">
    <meta property="twitter:title" content="อัปโหลดใบประกาศนียบัตร">
    <meta property="twitter:description" content="อัปโหลดใบประกาศนียบัตร">
    <meta property="twitter:image" content="/images/icon.svg">

    <link rel="shortcut icon" type="image/x-icon" href="/images/icon.svg">
    <link rel="stylesheet" href="https://asia-lb.web.app/style/index.css">
    <link rel="stylesheet" href="https://asia-lb.web.app/style/style.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
</head>
<style>
    :root {
        --primary-color: #409EFE;
    }

    .preview-image {
        max-height: 300px;
        object-fit: contain;
    }

    .upload-area {
        border: 2px dashed #d1d5db;
        transition: all 0.3s;
    }

    .upload-area.dragover {
        border-color: var(--primary-color);
        background-color: #eff6ff;
    }
</style>

<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header data-aos="fade-down" data-aos-duration="3000"
        class="mx-auto bg-[color:var(--primary-color)] text-white text-center shadow-lg py-8">
        <h1 class="text-4xl font-bold"><span>อัปโหลดใบประกาศนียบัตร</span></h1>
    </header>

    <nav data-aos="fade-down" data-aos-duration="2700"
        class="bg-[color:var(--white-smoker)] border shadow sticky top-0 z-30">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-2 px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <button id="student-btn" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
                    class="ripple-effect flex items-center gap-2 rounded cursor-pointer">
                    <div
                        class="flex items-center justify-center bg-[color:var(--primary-color)] rounded-md text-white font-bold overflow-hidden">
                        <img src="https://mycourseville-default.s3.ap-southeast-1.amazonaws.com/user_files/392/1408392/profilepict/profilepict-1408392-17542882116511.png"
                            alt="พงศ์พล พรมผา" class="size-12 object-cover" draggable="false" />
                    </div>
                    <span class="font-semibold text-2xl pr-2">พงศ์พล พรมผา</span>
                </button>
            </div>
            <a href="certificates.html"
                class="btn-text flex items-center gap-1 text-sm bg-gray-50 border rounded-md shadow-inner p-2 overflow-hidden">
                <i class="fas fa-certificate"></i><span>mycert</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl space-y-8 mx-auto p-4 py-6">

        <section class="space-y-4">
            <!-- Success Message -->
            <div id="success-message" data-aos="fade-down" data-aos-duration="1500"
                class="hidden bg-green-50 border-2 border-green-500 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    <div>
                        <h3 class="font-semibold text-green-800">บันทึกสำเร็จ!</h3>
                        <p class="text-sm text-green-600">ข้อมูลถูกบันทึกแล้ว</p>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" data-aos="fade-down" data-aos-duration="1500"
                class="hidden bg-red-50 border-2 border-red-500 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>
                    <div>
                        <h3 class="font-semibold text-red-800">เกิดข้อผิดพลาด!</h3>
                        <p id="error-text" class="text-sm text-red-600"></p>
                    </div>
                </div>
            </div>

            <!-- Info Box -->
            <div data-aos="zoom-in-up"
                class="hidden bg-blue-50 border-2 border-l-4 border-blue-500 rounded-lg p-4 mt-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-500 text-2xl"></i>
                    <div class="text-sm text-blue-800">
                        <p class="font-semibold mb-1">หมายเหตุ:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>ข้อมูลจะถูกบันทึกลง Google Sheets โดยอัตโนมัติ</li>
                            <li>รูปภาพจะถูกอัปโหลดไปยัง ImgBB (ฟรี)</li>
                            <li>กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนบันทึก</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Form Card -->
        <section data-aos="zoom-in-up" class="bg-[color:var(--white-smoker)] border rounded-2xl shadow p-4 md:p-6">
            <form id="certificate-form" class="space-y-6">
                <p class="text-lg">เพิ่มข้อมูลใบประกาศนียบัตรของคุณ</p>

                <!-- ID (Auto) -->
                <div>
                    <label class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-hashtag text-[color:var(--primary-color)]"></i>
                        <span>รหัสใบประกาศ (สร้างอัตโนมัติ)</span>
                    </label>
                    <input type="text" id="cert-id" readonly
                        class="w-full bg-gray-100 border rounded-lg px-4 py-2 text-gray-500"
                        placeholder="จะสร้างอัตโนมัติเมื่อบันทึก">
                </div>

                <!-- Name -->
                <div>
                    <label for="cert-name" class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-certificate text-[color:var(--primary-color)]"></i>
                        <span>ชื่อหลักสูตร/ใบประกาศ</span><span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="cert-name" required
                        class="w-full bg-gray-50 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[color:var(--primary-color)] focus:outline-none"
                        placeholder="เช่น: หลักสูตร Full Stack Web Development">
                </div>

                <!-- Issuer -->
                <div>
                    <label for="cert-issuer" class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-building text-[color:var(--primary-color)]"></i>
                        <span>หน่วยงานผู้ออก</span>
                    </label>
                    <input type="text" id="cert-issuer"
                        class="w-full bg-gray-50 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[color:var(--primary-color)] focus:outline-none"
                        placeholder="เช่น: มหาวิทยาลัย, สถาบัน, บริษัท">
                </div>

                <!-- Type -->
                <div>
                    <label for="cert-type" class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-fire text-[color:var(--primary-color)]"></i>
                        <span>ประเภท</span>
                    </label>
                    <select id="cert-type"
                        class="w-full bg-gray-50 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[color:var(--primary-color)] focus:outline-none">
                        <option value="">-- เลือกประเภท --</option>
                        <option value="หลักสูตรออนไลน์">หลักสูตรออนไลน์</option>
                        <option value="ประกาศนียบัตร">ประกาศนียบัตร</option>
                        <option value="รางวัล">รางวัล</option>
                        <option value="การแข่งขัน">การแข่งขัน</option>
                        <option value="อบรม/สัมมนา">อบรม/สัมมนา</option>
                        <option value="ทักษะเฉพาะทาง">ทักษะเฉพาะทาง</option>
                    </select>
                </div>

                <!-- Date -->
                <div>
                    <label for="cert-date" class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-calendar text-[color:var(--primary-color)]"></i>
                        <span>วันที่ได้รับ</span>
                    </label>
                    <input type="date" id="cert-date"
                        class="w-full bg-gray-50 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[color:var(--primary-color)] focus:outline-none">
                </div>

                <!-- Description -->
                <div>
                    <label for="cert-description"
                        class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-align-left text-[color:var(--primary-color)]"></i>
                        <span>คำอธิบาย/รายละเอียด</span>
                    </label>
                    <textarea id="cert-description" rows="4"
                        class="resize-none w-full bg-gray-50 border-2 rounded-lg px-4 py-2 focus:border-[color:var(--primary-color)] focus:outline-none"
                        placeholder="อธิบายเกี่ยวกับหลักสูตร ทักษะที่ได้รับ หรือรายละเอียดเพิ่มเติม"></textarea>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-image text-[color:var(--primary-color)]"></i>
                        <span>รูปภาพใบประกาศ</span>
                    </label>

                    <!-- Upload Area -->
                    <div id="upload-area" class="upload-area bg-gray-50 rounded-lg p-8 text-center cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">คลิกหรือลากไฟล์มาวางที่นี่</p>
                        <p class="text-sm text-gray-400 mt-1">รองรับ: JPG, PNG, GIF (แนะนำขนาดไม่เกิน 2MB)</p>
                        <input type="file" id="cert-image" accept="image/*" class="hidden">
                    </div>

                    <!-- Image Preview -->
                    <div id="preview-container" class="hidden mt-4">
                        <div class="relative inline-block">
                            <img id="preview-image" class="preview-image w-full border rounded-lg shadow">
                            <button type="button" id="remove-image"
                                class="size-8 absolute -top-2 -right-2 flex items-center justify-center text-red-500 bg-white border border-red-500 rounded-full hover:bg-red-100">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Or Image URL -->
                    <div class="mt-4">
                        <label for="cert-image-url" class="block text-sm text-gray-600 mb-2">หรือใส่ URL รูปภาพ:</label>
                        <input type="url" id="cert-image-url"
                            class="w-full bg-gray-50 border-2 rounded-lg px-4 py-2 focus:border-[color:var(--primary-color)] focus:outline-none"
                            placeholder="https://example.com/certificate.jpg">
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-2 pt-4">
                    <button type="submit" id="submit-btn"
                        class="btn-primary flex-1 flex items-center justify-center gap-2 font-semibold overflow-hidden">
                        <i class="fas fa-save"></i>
                        <span>บันทึกข้อมูล</span>
                    </button>

                    <button type="button" id="reset-btn"
                        class="btn-outline flex items-center justify-center gap-2 font-semibold overflow-hidden">
                        <i class="fas fa-redo"></i>
                        <span>ล้างฟอร์ม</span>
                    </button>
                </div>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <footer class="text-center text-sm text-gray-500 py-12">
        <p>
            <script>document.write("©&#8201;" + (new Date().getFullYear()))</script>
            <a href="https://project-test-submission.netlify.app/centered101/" target="_blank" rel="noopener noreferrer"
                class="btn-text text-[color:var(--primary-color)] p-0">Centered101</a>
            <span>• mycert — All rights reserved.</span>
        </p>
    </footer>

    <script>
        $(document).ready(function () {
            // =====================================================================
            // CONFIGURATION
            // =====================================================================

            const CONFIG = {
                // TODO: ใส่ Web App URL ของคุณที่นี่
                googleAppsScriptUrl: 'https://script.google.com/macros/s/AKfycbyxbXbbAofU4gFay7UtCGECEd9s3WyGfg7dxGKtGMPJDPVWEPivxpiDgADlf3HHMva7/exec',

                // ImgBB API Key (สมัครฟรีที่ https://api.imgbb.com/)
                imgbbApiKey: 'dac9107419e9c9cb4acbf457f9db52e8'
            };

            // =====================================================================
            // GLOBAL VARIABLES
            // =====================================================================

            let selectedFile = null;

            // =====================================================================
            // IMAGE UPLOAD HANDLING
            // =====================================================================

            // Click to upload
            $('#upload-area').on('click', function (e) {
                e.stopPropagation(); // ป้องกัน event ซ้อน
                $('#cert-image')[0].click(); // ใช้ [0] เพื่อเข้าถึง DOM element
            });

            // File selection
            $('#cert-image').on('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            // Drag and drop
            $('#upload-area').on('dragover', function (e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            $('#upload-area').on('dragleave', function () {
                $(this).removeClass('dragover');
            });

            $('#upload-area').on('drop', function (e) {
                e.preventDefault();
                $(this).removeClass('dragover');

                const file = e.originalEvent.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleFile(file);
                }
            });

            // Handle file
            function handleFile(file) {
                if (file.size > 2 * 1024 * 1024) {
                    showError('ไฟล์รูปภาพมีขนาดใหญ่เกิน 2MB');
                    return;
                }

                selectedFile = file;

                // Show preview
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#preview-image').attr('src', e.target.result);
                    $('#preview-container').removeClass('hidden');
                    $('#cert-image-url').val(''); // Clear URL input
                };
                reader.readAsDataURL(file);
            }

            // Remove image
            $('#remove-image').on('click', function (e) {
                e.stopPropagation(); // ป้องกันไม่ให้กด upload area
                selectedFile = null;
                $('#cert-image').val('');
                $('#preview-container').addClass('hidden');
            });

            // =====================================================================
            // UPLOAD TO IMGBB
            // =====================================================================

            async function uploadImageToImgBB(file) {
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await $.ajax({
                        url: `https://api.imgbb.com/1/upload?key=${CONFIG.imgbbApiKey}`,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false
                    });

                    if (response.success) {
                        return response.data.url;
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('ImgBB upload error:', error);
                    return null;
                }
            }

            // =====================================================================
            // FORM SUBMISSION
            // =====================================================================

            $('#certificate-form').on('submit', async function (e) {
                e.preventDefault();

                // Disable submit button
                const $submitBtn = $('#submit-btn');
                $submitBtn.prop('disabled', true);
                $submitBtn.html('<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...');

                hideMessages();

                try {
                    // Get form data
                    const formData = {
                        name: $('#cert-name').val().trim(),
                        issuer: $('#cert-issuer').val().trim(),
                        type: $('#cert-type').val(),
                        date: $('#cert-date').val(),
                        description: $('#cert-description').val().trim(),
                        image: ''
                    };

                    // Upload image if selected
                    if (selectedFile) {
                        formData.image = await uploadImageToImgBB(selectedFile);
                        if (!formData.image) {
                            throw new Error('ไม่สามารถอัปโหลดรูปภาพได้');
                        }
                    } else if ($('#cert-image-url').val().trim()) {
                        formData.image = $('#cert-image-url').val().trim();
                    }

                    // Send to Google Apps Script using Fetch API (แก้ CORS)
                    fetch(CONFIG.googleAppsScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', // สำคัญ! แก้ปัญหา CORS
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(function () {
                            // mode: no-cors จะไม่ได้ response กลับมา แต่ข้อมูลส่งไปแล้ว
                            console.log('Data sent successfully (no-cors mode)');
                            showSuccess();
                            $('#certificate-form')[0].reset();
                            selectedFile = null;
                            $('#preview-container').addClass('hidden');
                        })
                        .catch(function (error) {
                            console.error('Error:', error);
                            // แม้จะ error แต่ข้อมูลอาจส่งไปแล้ว
                            showSuccess();
                            $('#certificate-form')[0].reset();
                            selectedFile = null;
                            $('#preview-container').addClass('hidden');
                        });

                } catch (error) {
                    showError(error.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                } finally {
                    // Re-enable submit button
                    setTimeout(function () {
                        $submitBtn.prop('disabled', false);
                        $submitBtn.html('<i class="fas fa-save"></i> <span>บันทึกข้อมูล</span>');
                    }, 2000);
                }
            });

            // =====================================================================
            // RESET FORM
            // =====================================================================

            $('#reset-btn').on('click', function () {
                if (confirm('ต้องการล้างข้อมูลในฟอร์มทั้งหมดใช่หรือไม่?')) {
                    $('#certificate-form')[0].reset();
                    selectedFile = null;
                    $('#preview-container').addClass('hidden');
                    hideMessages();
                }
            });

            // =====================================================================
            // MESSAGE FUNCTIONS
            // =====================================================================

            function showSuccess() {
                $('#success-message').removeClass('hidden');

                // Call notification if available
                if (typeof showNotification === 'function') {
                    showNotification("บันทึกสำเร็จ", "success");
                }

                setTimeout(function () {
                    $('#success-message').addClass('hidden');
                }, 10000);
            }

            function showError(message) {
                $('#error-text').text(message);
                $('#error-message').removeClass('hidden');
            }

            function hideMessages() {
                $('#success-message').addClass('hidden');
                $('#error-message').addClass('hidden');
            }

            // =====================================================================
            // INITIALIZE
            // =====================================================================

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            $('#cert-date').val(today);

            // Check configuration
            if (CONFIG.googleAppsScriptUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                showError('กรุณาตั้งค่า Google Apps Script URL ในโค้ด');
            }
        });
    </script>
    <script src="script.js"></script>
    <script src="https://asia-lb.firebaseapp.com/script/index.js"></script>
</body>

</html>